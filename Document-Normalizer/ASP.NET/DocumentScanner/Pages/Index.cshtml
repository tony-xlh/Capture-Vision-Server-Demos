@page
@model IndexModel
@{
    ViewData["Title"] = "Home page";
}
<style>
* {
  padding:0;
  margin:0;
}

body {
  -ms-content-zooming: none;
}

img {
  max-width: 100%;
  max-height: 350px;
  margin-bottom: 1em;
  display: block;
}

#cropper {
  position: fixed;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
}
</style>
<script type="module">
  import { defineCustomElements } from 'https://cdn.jsdelivr.net/npm/image-cropper-component/dist/esm/loader.js';
  defineCustomElements();
</script>

<div>
  <h2>Document Image Cropper Demo</h2>
  Load local image:
  <input type="file" id="file" onchange="loadImageFromFile();" accept=".jpg,.jpeg,.png,.bmp" />
  <div>
    <button onclick="openCropper()">Open Cropper</button>
    <span id="status"></span>
  </div>
  <div>
    <div>Original:</div>
    <div class="orginalImageContainer"></div>
    <div>Cropped:</div>
    <div class="croppedImageContainer">
    </div>
  </div>
  <div id="cropper" style="display:none;">
    <image-cropper style="--active-stroke:5;--active-color:orange;--inactive-color:orange;"></image-cropper>
  </div>
</div>

<script>
function registerEventsForCropper(){
  console.log("register events");
  let cropper = document.querySelector("image-cropper");
  const canceled = () => {
    document.getElementById("cropper").style.display = "none";
    document.body.style.overflow = "";
  }
  const confirmed = async () => {
    document.getElementById("cropper").style.display = "none";
    document.body.style.overflow = "";
  }
  cropper.addEventListener("canceled",canceled);
  cropper.addEventListener("confirmed",confirmed);
}
function loadImageFromFile() { 
  let files = document.getElementById('file').files;
  if (files.length == 0) {
    return;
  }
  let file = files[0];
  fileReader = new FileReader();
  fileReader.onload = function(e){
    let container = document.getElementsByClassName("orginalImageContainer")[0];
    container.innerHTML = "";
    let img = document.createElement("img");
    img.src = e.target.result;
    img.id = "original";
    container.appendChild(img);
  };
  fileReader.onerror = function () {
    console.warn('oops, something went wrong.');
  };
  fileReader.readAsDataURL(file);
}
async function openCropper(){
  if (!document.getElementById("original")) {
    return;
  }
  document.body.style.overflow = "hidden";
  let cropper = document.querySelector("image-cropper");
  cropper.img = document.getElementById("original");
  cropper.inactiveSelections = [];
  document.getElementById("status").innerText = "Detecting...";
  let detectionResult = await detectQuad(cropper.img.src);
  if (detectionResult.success == true) {
    console.log("set quad");
    let quad = detectionResult.polygon;
    cropper.quad = quad;
    console.log(cropper.quad);
  }
  document.getElementById("status").innerText = "";
  document.getElementById("cropper").style.display = "";
}

async function detectQuad(dataURL){
  let base64 = dataURL.substring(dataURL.indexOf(",")+1,dataURL.length);
  let url = "/api/document/detect";
  data = {Base64:base64}
  const response = await fetch(url, {
    method: "POST", 
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify(data),
  });
  let json = await response.json();
  console.log(json);
  return json;
}
</script>
